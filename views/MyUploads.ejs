<%- include ("includes/header", { "title": "My Uploads" }) %>

<div class="container" style="margin-top: 50px; margin-bottom: 50px">
  <%- include ("includes/ResponseAlert", { "request": request }) %>

  <div class="row">
    <div class="col-md-4">
      <h1>
        <% if (folderName == "") { %> My Uploads <% error:false %> <% } else {
        %> <%= folderName %> <% } %>
      </h1>
    </div>

    <% if (createdAt != "") { %>
    <div class="col-md-4">
      Created at: <% createdAt = new Date(createdAt); createdAt =
      createdAt.getDate() + " " + months[createdAt.getMonth()] + ", " +
      createdAt.getFullYear() + " " + createdAt.getHours() + ":" +
      createdAt.getMinutes() + ":" + createdAt.getSeconds(); %> <%= createdAt %>
    </div>
    <% } %>

    <div class="col-md-4">
      <% if (_id != null) {%>

      <div class="dropdown" style="display: initial">
        <button
          type="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          class="btn btn-primary"
        >
          More <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <form
              action="<%= request.mainURL %>/DeleteDirectory"
              onsubmit="return confirm('are you sure you want to delete this folder and all the files in it?'); "
              method="post"
            >
              <input type="hidden" name="_id" value="<%= _id %>" required />
              <input
                type="submit"
                value="Delete"
                class="btn btn-danger btn-block"
              />
            </form>
          </li>
        </ul>
      </div>
      <% } %>
      <a
        href="#"
        id="open-file-uploader"
        class="btn btn-primary"
        on
        click="selectFileForUpload();"
        >Upload</a
      >

      <button
        type="button"
        class="btn btn-primary"
        onClick="onClickCreateFolder();"
      >
        Create folder
      </button>
    </div>
  </div>

  <div class="row">
    <% uploaded.forEach(function(singleFile) { var fileSize = 0; %>
    <div class="card">
      <div
        class="card-body"
        style="font-size: 100px; text-align: center; height: 300px"
      >
        <% if (singleFile.type == "folder") { %>
        <i class="fa fa-folder-open-o"></i>
        <% } else { %>
        <i class="fa fa-file-text-o"></i>
        <% } %>
      </div>
      <div class="card-footer">
        <div class="row">
          <div class="col-md-8">
            <% if(singleFile.type == "folder") { fileSize =
            getFolderSize(singleFile.files); fileSize = formatBytes(fileSize);
            %>
            <h3>
              <a href="<%= request.mainURL + '/MyUploads/' +singleFile._id %>">
                <%= singleFile.folderName.substring(0,10) %> <%=
                (singleFile.folderName.length > 10) ? "..." : "" %>
              </a>
            </h3>
            <% } else { fileSize = formatBytes(singleFile.size); %>
            <h3>
              <a
                href="#"
                onclick="viewFile(this);"
                data-id="<%=singleFile._id %>"
                data-name="<%= singleFile.name %>"
                data-type="<%= singleFile.createdAt %>"
              >
                <%=singleFile.name.substring(0,10) %> <%=
                (singleFile.name.length > 10) ? "..." : "" %>
              </a>
            </h3>
            <% } %>
          </div>
          <div class="col-md-4">
            <p style="position: relative; top: 10px"><%= fileSize %></p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% }) %>
</div>

<form
  method="POST"
  action="<%= request.mainURL %>/CreateFolder"
  id="form-create-folder"
>
  <input type="hidden" name="name" required />
  <input type="hidden" name="_id" value="<%= _id %>" />
</form>

<form
  method="POST"
  action="<%= request.mainURL %>/UploadFile"
  enctype="multipart/form-data"
  id="form-upload-file"
>
  <input type="hidden" name="_id" value="<%= _id %>" />
  <input
    type="file"
    name="file"
    id="input-file-upload"
    style="position: fixed"
    onchange="confirmUpload();"
    required
  />
</form>

<div
  class="modal fade"
  id="viewFileModal"
  tabindex="-1"
  role="dialog"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">x</span>
        </button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">
          Close
        </button>
        <form
          class=""
          action="<%= request.mainURL %>/DeleteFile"
          id="form-delete-file"
          method="post"
        >
          <input type="hidden" name="_id" required />
          <button
            type="button"
            class="btn btn-danger"
            onclick="confirmDeleteFile(this);"
          >
            Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  var finalFolder;

  function viewFile(self) {
    var _id = self.getAttribute("data-id");
    var name = self.getAttribute("data-name");
    var type = self.getAttribute("data-type");

    var createdAt = self.getAttribute("data-created-at");
    createdAt = parseFloat(createdAt);
    createdAt = new Date(createdAt);
    createdAt =
      createdAt.getDate() +
      " " +
      createdAt.getMonth() +
      ", " +
      createdAt.getFullYear() +
      " " +
      createdAt.getHours() +
      ":" +
      createdAt.getMinutes() +
      ":" +
      createdAt.getSeconds();

    document.querySelector("#viewFileModal .modal-title").innerHTML = name;

    var modalBodyHtml = "";
    modalBodyHtml += "<p>Created at:" + createdAt + "</p>";
    document.querySelector("#viewFileModal .modal-body").innerHTML =
      modalBodyHtml;
    $("#viewFileModal").modal("show");

    document.getElementById("form-delete-file")._id.value = _id;
  }

  function confirmUpload() {
    if (confirm("Upload the selected file to the server ?")) {
      document.getElementById("form-upload-file").submit();
    }
  }
  function selectFileForUpload() {
    const aTag = document.getElementById("open-file-uploader");
    const fileInput = document.getElementById("input-file-upload");
    aTag.addEventListener("click", () => fileInput.click());
  }
  function onClickCreateFolder() {
    var folderName = prompt("Please enter folder name", "");
    if (folderName != null) {
      document.getElementById("form-create-folder").name.value = folderName;
      document.getElementById("form-create-folder").submit();
    }
  }
  finalFolder = folderName;

  function onClickDeleteFolder(form) {
    swal({
      title: "Are you sure?",
      text: "Once deleted, you will not be able to recover this folder!",
      icon: "warning",
      buttons: true,
      dangerMode: true,
    }).then(function (willDelete) {
      if (willDelete) {
        document.getElementById("form-delete-folder");
        document.getElementById("form-delete-folder").submit();
      }
    });
  }

  function confirmDeleteFile(form) {
    console.log("function called");
    swal({
      title: "Are you sure?",
      text: "Once deleted, you will not be able to recover this file!",
      icon: "warning",
      buttons: true,
      dangerMode: true,
    }).then(function (willDelete) {
      if (willDelete) {
        document.getElementById("form-delete-file").submit();
      }
    });
  }
</script>
<%- include("includes/footer") %>
